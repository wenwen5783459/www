<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>å¤–ç¶²å½ˆå¹•æ”»æ“Šä¸»æ’­</title>
<style>
body { margin:0; overflow:hidden; background:#222; color:#fff; font-family:sans-serif; }
#controls { position:absolute; top:10px; left:10px; z-index:10; }
#controls input { margin-right:5px; }
</style>
</head>
<body>

<div id="controls">
  <input type="text" id="name" placeholder="ç©å®¶åç¨±">
  <input type="text" id="msg" placeholder="å½ˆå¹•æ–‡å­—">
  <button id="generate">ç”Ÿæˆåˆ†äº«ç¶²å€</button>
  <p id="link"></p>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const bullets = [];
const player = { x:100, y:canvas.height/2-50, width:100, height:100, hp:100, speed:10, shield:false, speedBoost:false };

let keys = {};
document.addEventListener('keydown', e => keys[e.key]=true);
document.addEventListener('keyup', e=>keys[e.key]=false);

// WebSocket é€£ç·šï¼Œæœƒç”± start_server_ngrok.js è‡ªå‹•æ›´æ–°
const ws = new WebSocket('ws://PLACEHOLDER_WS_URL');

function getRandomColor() {
  const colors = ['yellow','cyan','lime','magenta','orange','pink','white'];
  return colors[Math.floor(Math.random()*colors.length)];
}

// è‡ªå‹•å¾ç¶²å€ç™¼é€å½ˆå¹•
function autoSendBullet() {
  const params = new URLSearchParams(window.location.search);
  const user = params.get('user') || 'ç©å®¶';
  const msg = params.get('msg');
  if(msg){
    ws.send(JSON.stringify({user,msg}));
    params.delete('msg');
    history.replaceState(null,'',`${window.location.pathname}?${params.toString()}`);
  }
}
window.addEventListener('load', autoSendBullet);

// æ”¶åˆ°å½ˆå¹•
ws.onmessage = (event)=>{
  const data = JSON.parse(event.data);
  bullets.push({
    text:`${data.user}: ${data.msg}`,
    x:canvas.width,
    y:Math.random()*(canvas.height-30),
    speed:3 + data.msg.length*0.1,
    color:getRandomColor()
  });
};

// ä¸»æ’­æŠ€èƒ½æŒ‰éµ
document.addEventListener('keydown', e=>{
  if(e.key==='d' || e.key==='D'){ player.shield=true; setTimeout(()=>player.shield=false,5000); }
  if(e.key==='h' || e.key==='H'){ player.hp+=20; if(player.hp>100) player.hp=100; }
  if(e.key==='Shift'){ player.speedBoost=true; player.speed*=2; setTimeout(()=>{player.speedBoost=false; player.speed/=2},3000);}
});

// ç”Ÿæˆåˆ†äº«ç¶²å€æŒ‰éˆ•
document.getElementById('generate').addEventListener('click',()=>{
  const name = encodeURIComponent(document.getElementById('name').value || 'ç©å®¶');
  const msg = encodeURIComponent(document.getElementById('msg').value || 'ğŸ”¥');
  const url = `${window.location.origin}${window.location.pathname}?user=${name}&msg=${msg}`;
  document.getElementById('link').innerHTML = `<a href="${url}" target="_blank">${url}</a>`;
});

// éŠæˆ²ä¸»å¾ªç’°
function gameLoop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(keys['ArrowUp']||keys['w']) player.y -= player.speed;
  if(keys['ArrowDown']||keys['s']) player.y += player.speed;
  if(player.y<0) player.y=0;
  if(player.y+player.height>canvas.height) player.y=canvas.height-player.height;

  ctx.fillStyle = player.shield?'cyan':'red';
  ctx.fillRect(player.x,player.y,player.width,player.height);
  ctx.fillStyle='white';
  ctx.font='20px sans-serif';
  ctx.fillText(`HP: ${player.hp}`,player.x,player.y-10);

  bullets.forEach((b,index)=>{
    ctx.fillStyle=b.color;
    ctx.fillText(b.text,b.x,b.y);
    b.x -= b.speed;
    if(b.x < player.x+player.width && b.x + ctx.measureText(b.text).width > player.x &&
       b.y < player.y+player.height && b.y>player.y){
      if(!player.shield) player.hp-=5;
      bullets.splice(index,1);
    }
    if(b.x + ctx.measureText(b.text).width <0) bullets.splice(index,1);
  });

  requestAnimationFrame(gameLoop);
}
gameLoop();
</script>

</body>
</html>